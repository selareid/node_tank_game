<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tank Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        var socket = io();
        let userId;

        socket.on('userId', function (d) {
            console.log('user id ' + d);
            userId = d;
        });

        socket.on('disconnect', function () {
            console.log('disconnected from server');
            document.body.innerHTML = "SERVER DISCONNECTED <br> ATTEMPTING RECONNECT";
            window.location.reload();
        });
    </script>
</head>
<body>
    <div id="playArea" style="float: left;"></div>
    <div id="sideBar" style="float: left; width:max-content; height: auto; padding-left: 25px;">
        <p id="time">____</p>
        <p id="userListP"></p>
    </div>
</body>
<script>
    //grid width and height
    let bw = 100;
    let bh = 100;

    //padding around grid
    let p = 15;
 
    //size of canvas
    let cw = bw*5 + (p * 2) + 1;
    let ch = bh*5 + (p * 2) + 1;
    let canvas = $('<canvas/>').attr({id: "mainCanvas", width: cw, height: ch}).appendTo($('#playArea'));
    let context = canvas.get(0).getContext("2d");

    let worldInfo;
    let localUserList = {};
    let topLeftPos = {x: 0, y: 0};

    function updateSideBar() {
        //draw user at top
        $('#userListP').html(`${userId}: <br>&emsp; position: {x: ${localUserList[userId].position.x}, y: ${localUserList[userId].position.y}}`);

        //draw other users
        for (let uId in localUserList) {
            if (uId == userId) continue;
            $('#userListP').append(`<br>${uId}: <br>&emsp; position: {x: ${localUserList[uId].position.x}, y: ${localUserList[uId].position.y}}`);
        }
    }

    function drawBoard() {
        context.clearRect(0, 0, cw, ch); //clears the canvas

        //draw grid start
        for (var x = 0; x <= bw; x += 10) {
            context.moveTo(0.5 + x*5 + p, p);
            context.lineTo(0.5 + x*5 + p, bh*5 + p);
            context.font = '10px sans-serif';
            context.fillStyle = 'green';
            context.fillText(Math.floor(topLeftPos.x+x), -5 + x*5 + p, p);
        }

        for (var x = 0; x <= bh; x += 10) {
            context.moveTo(p, 0.5 + x*5 + p);
            context.lineTo(bw*5 + p, 0.5 + x*5 + p);
            context.font = '10px sans-serif';
            context.fillStyle = 'green';
            context.fillText(Math.floor(topLeftPos.y+x), 0, +5 + x*5 + p)
        }
        context.strokeStyle = "black";
        context.stroke();
        //draw grid end

        //draw players start
        for (let uId in localUserList) {
            let u = localUserList[uId];

            context.fillStyle = userId == uId ? 'rgba(0,255,0,0.75)' : 'rgba(64,64,285,0.75)';
            context.fillRect(p+u.position.x*5-20-topLeftPos.x*5, p+u.position.y*5-20-topLeftPos.y*5, 40, 40);
        }
        //draw players end
    }

    socket.on('worldInfo', function (worldInfo) {
        this.worldInfo = worldInfo;

        drawBoard();

        let mouseButtonDown = false;

        document.getElementById('mainCanvas').addEventListener('mousedown', function (event) {
            if (event.button === 0) mouseButtonDown = true;
        });

        document.addEventListener('mouseup', function (event) {
            if (event.button === 0) mouseButtonDown = false;
        });

        document.getElementById('mainCanvas').addEventListener('mousemove', function (event) {
            if (!mouseButtonDown) return;
            topLeftPos.x -= Math.floor(event.movementX*1000/5)/1000;
            topLeftPos.y -= Math.floor(event.movementY*1000/5)/1000;
            drawBoard();
        });

        socket.emit('getUserList');
        socket.on('userList', function (ul) {
            if (!userId) socket.emit('getUserList'); //who am I not received yet
            //if first load of list this session, center on player
            if (Object.keys(localUserList).length === 0) topLeftPos = {x: ul[userId].position.x-bw/2, y: ul[userId].position.y-bh/2};

            localUserList = ul;
            drawBoard();
            updateSideBar();
        });

        socket.emit('getEntities');
        socket.on('entities', function (entities) {
            console.log(entities);
        });

        socket.on('gameState', function (data) {
            $('#time').text(data.time);
            console.log('REMINDER: do things game simulation');
        }); //TODO TODO
    });

    socket.on('userDisconnected', function (disconnectedId) {
        delete localUserList[disconnectedId];
        drawBoard();
        updateSideBar();
    });


    function move(x, y) {
        localUserList[userId].position = {x, y};
        drawBoard();
        updateSideBar();
        socket.emit('userMove', {x: x, y: y});
    }
    socket.on('userMoved', (info) => {
        localUserList[info.id].position = info.position;
        updateSideBar();
        drawBoard();
    });
</script>
</html>