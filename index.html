<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tank Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="/Constants.js"></script>
    <script src="/draws.js"></script>
    <script>
        var socket = io();
        let userId;

        socket.on('userId', function (d) {
            console.log('user id ' + d);
            userId = d;
        });

        socket.on('disconnect', function () {
            console.log('disconnected from server');
            document.body.innerHTML = "SERVER DISCONNECTED <br> ATTEMPTING RECONNECT";
            window.location.reload();
        });
    </script>
</head>
<body>
    <div id="playArea" style="float: left;"></div>
    <div id="sideBar" style="float: left; width:max-content; height: auto; padding-left: 25px;">
        <p id="time">____</p>
        <p id="userListP"></p>
    </div>
</body>
<script>
    //grid width and height
    let bw = 100;
    let bh = 100;

    //padding around grid
    let p = 15;

    //size of canvas
    let cw = bw*5 + (p * 2) + 1;
    let ch = bh*5 + (p * 2) + 1;
    let canvas = $('<canvas/>').attr({id: "mainCanvas", width: cw, height: ch}).appendTo($('#playArea'));
    let context = canvas.get(0).getContext("2d");

    let worldInfo;
    let localUserList = {};
    let localGameStateLatest = {};
    let topLeftPos = {x: 0, y: 0};

    socket.on('worldInfo', function (worldInfo) {
        this.worldInfo = worldInfo;

        drawBoard();

        let mouseButtonDown = false;

        document.getElementById('mainCanvas').addEventListener('mousedown', function (event) {
            if (event.button === 0) mouseButtonDown = true;
        });

        document.addEventListener('mouseup', function (event) {
            if (event.button === 0) mouseButtonDown = false;
        });

        document.getElementById('mainCanvas').addEventListener('mousemove', function (event) {
            if (!mouseButtonDown) return;
            topLeftPos.x -= Math.floor(event.movementX*1000/5)/1000;
            topLeftPos.y -= Math.floor(event.movementY*1000/5)/1000;
            drawBoard();
        });

        socket.emit('getUserList');
        socket.on('userList', function (ul) {
            if (!userId) socket.emit('getUserList'); //who am I not received yet
            //if first load of list this session, center on player
            if (Object.keys(localUserList).length === 0) topLeftPos = {x: ul[userId].position.x-bw/2, y: ul[userId].position.y-bh/2};

            localUserList = ul;
            drawBoard();
            updateSideBar();
        });

        socket.on('gameState', function (data) {
            $('#time').text(data.time);
            console.log('REMINDER: do things game simulation');
            // console.log(data.entities);
            localGameStateLatest = data;
            drawBoard(); //draw play field again, don't need to do sidebar cause players not updates
            //TODO maybe update sidebar once added player things
        }); //TODO TODO entities n things
    });

    socket.on('userDisconnected', function (disconnectedId) {
        delete localUserList[disconnectedId];
        drawBoard();
        updateSideBar();
    });


    function move(x, y) {
        localUserList[userId].position = {x, y};
        drawBoard();
        updateSideBar();
        socket.emit('userMove', {x: x, y: y});
    }
    socket.on('userMoved', (info) => {
        localUserList[info.id].position = info.position;
        updateSideBar();
        drawBoard();
    });
</script>
</html>